<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin - Agenda TÃ©cnica</title>

<!-- FULLCALENDAR -->
<link rel="stylesheet" href="https://unpkg.com/fullcalendar@5.11.5/main.min.css">
<script src="https://unpkg.com/fullcalendar@5.11.5/main.min.js"></script>

<style>
body{margin:0;font-family:'Segoe UI',sans-serif;background:#f1f3f4;}
.header{background:#000;color:#fff;padding:16px 20px;display:flex;justify-content:space-between;align-items:center;font-size:20px;font-weight:600;}
.header button{background:#dc3545;border:none;color:white;padding:8px 14px;border-radius:8px;cursor:pointer;}
.container{max-width:1600px;margin:auto;padding:20px;}
.grid{display:grid;grid-template-columns:320px 1fr 320px;gap:16px;}
.card{background:white;padding:16px;border-radius:16px;box-shadow:0 8px 20px rgba(0,0,0,.08);}
h3{margin-top:0}
form input,form select,form button{width:100%;padding:8px;margin-top:6px;}
form button{background:#1a73e8;color:white;border:none;border-radius:8px;}
.lista-scroll{max-height:600px;overflow-y:auto;}
.item{padding:12px;margin-bottom:12px;background:#fafafa;border-radius:10px;border-left:6px solid;}
.badge{display:inline-block;padding:3px 8px;border-radius:6px;font-size:12px;color:white;}
.badge.Agendado{background:#1a73e8}.badge.Pendente{background:#fbbc04}.badge.ConcluÃ­do{background:#34a853}
button.maps{background:#34a853;color:white;border:none;padding:6px 10px;border-radius:6px;margin-top:6px;}
button.delete{background:#dc3545;color:white;border:none;padding:6px 10px;border-radius:6px;margin-top:6px;}
:root{--instalacao:#1a73e8;--manutencao:#f57c00;--suporte:#8e24aa;--visita:#2e7d32;}
.modal{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;z-index:1000;}
.modal-content{background:white;padding:20px;width:340px;border-radius:14px;}
.close{text-align:right;cursor:pointer;font-weight:bold;}
@media(max-width:900px){.grid{grid-template-columns:1fr}}
</style>
</head>

<body>

<div class="header">
  ğŸ“Š Painel Administrativo
  <button onclick="logout()">ğŸšª Sair</button>
</div>

<div class="container">
  <div class="grid">

    <div class="card">
      <h3>Novo Atendimento</h3>
      <form id="form">
        <input id="cliente" placeholder="Cliente" required>
        <input id="telefone" placeholder="Telefone (somente nÃºmeros)" required>
        <input id="endereco" placeholder="EndereÃ§o" required>

        <select id="servico">
          <option>InstalaÃ§Ã£o</option>
          <option>ManutenÃ§Ã£o</option>
          <option>Suporte TÃ©cnico</option>
          <option>Visita TÃ©cnica</option>
        </select>

        <input type="date" id="data" required>
        <input type="time" id="hora" required>
        <button>Salvar</button>
      </form>
    </div>

    <div class="card">
      <h3>ğŸ“… Agenda</h3>
      <div id="calendar"></div>
    </div>

    <div class="card">
      <h3>ğŸ“‹ Visitas</h3>
      <div id="lista" class="lista-scroll"></div>
    </div>

  </div>
</div>

<!-- MODAL -->
<div class="modal" id="modal">
  <div class="modal-content">
    <div class="close" onclick="modal.style.display='none'">âœ–</div>
    <h4 id="modalTitulo"></h4>
    <p id="modalInfo"></p>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, updateDoc, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyBPijStbscjxd37siV7cafBy5thQhrv8KQ",
  authDomain: "agenda-9dfe3.firebaseapp.com",
  projectId: "agenda-9dfe3",
  storageBucket: "agenda-9dfe3.appspot.com",
  messagingSenderId: "627589847930",
  appId: "1:627589847930:web:24f29ea4646ee5feb1d4c3"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);
const colAgenda = collection(db,"agenda");

const form = document.getElementById("form");
const lista = document.getElementById("lista");
const calendarEl = document.getElementById("calendar");
const modal = document.getElementById("modal");
const modalTitulo = document.getElementById("modalTitulo");
const modalInfo = document.getElementById("modalInfo");

let agenda = [];
let calendar;

const coresServico={
  "InstalaÃ§Ã£o":"var(--instalacao)",
  "ManutenÃ§Ã£o":"var(--manutencao)",
  "Suporte TÃ©cnico":"var(--suporte)",
  "Visita TÃ©cnica":"var(--visita)"
};

/* ğŸ”’ PROTEÃ‡ÃƒO */
onAuthStateChanged(auth,user=>{
  if(!user){window.location.href="index.html";}
});

/* ğŸšª LOGOUT */
window.logout = ()=>{signOut(auth).then(()=>window.location.href="index.html");};

/* ğŸ”¹ Carregar agenda */
async function carregarAgenda(){
  agenda=[];
  const snap = await getDocs(colAgenda);
  snap.forEach(d=>agenda.push({id:d.id,...d.data()}));
  atualizar();
}

/* ğŸ”¹ Criar atendimento */
form.onsubmit = async e=>{
  e.preventDefault();
  const cliente = document.getElementById("cliente").value;
  const telefone = document.getElementById("telefone").value.replace(/\D/g,"");
  const endereco = document.getElementById("endereco").value;
  const servico = document.getElementById("servico").value;
  const data = document.getElementById("data").value;
  const hora = document.getElementById("hora").value;

  if(!cliente || !telefone || !endereco || !data || !hora) return;

  await addDoc(colAgenda,{cliente,telefone,endereco,servico,data,hora,status:"Agendado"});
  form.reset();
  carregarAgenda();
};

/* ğŸ”¹ Alterar status */
window.alterarStatus = async (id,status)=>{
  await updateDoc(doc(db,"agenda",id),{status});
  carregarAgenda();
};

/* ğŸ”¹ Apagar atendimento */
window.apagar = async id=>{
  if(confirm("Deseja apagar este atendimento?")){
    await deleteDoc(doc(db,"agenda",id));
    carregarAgenda();
  }
};

/* ğŸ”¹ Atualizar lista */
function atualizarLista(){
  lista.innerHTML="";
  const agendaOrdenada = [...agenda].sort((a,b)=> new Date(a.data+"T"+a.hora)-new Date(b.data+"T"+b.hora));
  agendaOrdenada.forEach(a=>{
    const whatsapp=`https://wa.me/55${a.telefone}`;
    const maps=`https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(a.endereco)}`;
    lista.innerHTML+=`
      <div class="item" style="border-left-color:${coresServico[a.servico]}">
        <b>${a.cliente}</b><br>
        <small>ğŸ›  ${a.servico}</small><br>
        <small>ğŸ“… ${a.data} Ã s ${a.hora}</small><br>
        <small>ğŸ“ <a href="${whatsapp}" target="_blank">WhatsApp</a></small><br>
        <small>ğŸ“ ${a.endereco}</small><br>
        <button class="maps" onclick="window.open('${maps}','_blank')">ğŸ—ºï¸ TraÃ§ar rota</button><br><br>
        <span class="badge ${a.status}">${a.status}</span><br><br>
        <select onchange="alterarStatus('${a.id}',this.value)">
          <option ${a.status==="Pendente"?"selected":""}>Pendente</option>
          <option ${a.status==="Agendado"?"selected":""}>Agendado</option>
          <option ${a.status==="ConcluÃ­do"?"selected":""}>ConcluÃ­do</option>
        </select>
        <button class="delete" onclick="apagar('${a.id}')">Apagar</button>
      </div>`;
  });
}

/* ğŸ”¹ Atualizar FullCalendar */
function atualizarCalendario(){
  if(calendar) calendar.destroy();
  calendar = new FullCalendar.Calendar(calendarEl,{
    locale:"pt-br",
    height:650,
    events: agenda.map(a=>({title:a.cliente,start:`${a.data}T${a.hora}`,color:coresServico[a.servico],extendedProps:{...a}})),
    eventClick(info){
      const a=info.event.extendedProps;
      modalTitulo.innerText=`${a.cliente} - ${a.servico}`;
      modalInfo.innerHTML=`ğŸ“ <a href="https://wa.me/55${a.telefone}" target="_blank">WhatsApp</a><br>ğŸ“ ${a.endereco}<br>ğŸ“… ${a.data} Ã s ${a.hora}<br><b>Status:</b> ${a.status}`;
      modal.style.display="flex";
    }
  });
  calendar.render();
}

/* ğŸ”¹ Atualiza lista e calendÃ¡rio */
function atualizar(){atualizarLista();atualizarCalendario();}

/* ğŸ”¹ Fecha modal clicando fora */
window.onclick = e=>{if(e.target==modal) modal.style.display="none";}

/* ğŸ”¹ Inicializa */
window.onload = ()=>{carregarAgenda();}
</script>

</body>
</html>
